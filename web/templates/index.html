<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Docker Lab Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Minimal styling with Bootstrap (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >
  <style>
    body { background: #0f1220; color: #e6e6f0; }
    .card { background: #171a2d; border: 1px solid #242845; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .list-group-item { color: #e6e6f0; border-color: #242845; }
    .card h5, .card div { color: #e6e6f0; }
    .badge-ok { background: #26c281; }       /* green */
    .badge-bad { background: #ff6b6b; }      /* red */
    .glow:hover { box-shadow: 0 0 0.75rem rgba(38,194,129,0.6); transform: translateY(-1px); }
    .spin { display:inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    code { color: #c9d1ff; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 text-center">Docker Lab Status</h1>

    <div class="row g-4">
      <div class="col-12 col-lg-8 mx-auto">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">Services</h5>
            <div>
              <button id="refreshBtn" class="btn btn-success glow">Re-check Status</button>
              <button id="resetBtn" class="btn btn-outline-danger ms-2">Reset Demo Data</button>
            </div>
          </div>

          <ul class="list-group list-group-flush" id="statusList">
            <!-- Redis -->
            <li class="list-group-item bg-transparent">
              <div class="d-flex justify-content-between align-items-center">
                <div>Redis (cache)</div>
                {% if info.redis.ok %}
                  <span class="badge rounded-pill badge-ok">pong</span>
                {% else %}
                  <span class="badge rounded-pill badge-bad">error</span>
                {% endif %}
              </div>
              <div class="mt-2 small">
                <code>counter</code> = {{ info.redis.counter or 0 }},
                <code>dbsize</code> = {{ info.redis.dbsize or 0 }},
                <code>used_memory</code> = {{ info.redis.used_memory or "n/a" }}
              </div>
            </li>

            <!-- Postgres -->
            <li class="list-group-item bg-transparent">
              <div class="d-flex justify-content-between align-items-center">
                <div>Postgres (database)</div>
                {% if info.postgres.ok %}
                  <span class="badge rounded-pill badge-ok">ok</span>
                {% else %}
                  <span class="badge rounded-pill badge-bad">error</span>
                {% endif %}
              </div>
              <div class="mt-2 small">
                <code>server_version</code> = {{ info.postgres.server_version or "n/a" }},
                <code>rows_in_proof</code> = {{ info.postgres.rows_in_proof or 0 }},
                <code>last_insert_id</code> = {{ info.postgres.last_insert_id or "n/a" }}
              </div>
            </li>
          </ul>

          {% if info.errors and (info.errors.redis or info.errors.postgres) %}
          <div class="alert alert-danger mt-3">
            <strong>Errors:</strong>
            <pre class="mb-0 small">{{ info.errors | tojson(indent=2) }}</pre>
          </div>
          {% endif %}
        </div>

        <div class="text-center mt-4">
          <a class="btn btn-outline-light glow" href="#" id="demoBtn">Click me</a>
          <div id="demoToast" class="mt-3" style="display:none;">
            <span class="badge rounded-pill bg-info text-dark">ðŸ‘‹ Hello, World!</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const btn = document.getElementById('refreshBtn');
    const resetBtn = document.getElementById('resetBtn');
    const list = document.getElementById('statusList');
    const demoBtn = document.getElementById('demoBtn');
    const demoToast = document.getElementById('demoToast');

    demoBtn.addEventListener('click', (e) => {
      e.preventDefault();
      demoToast.style.display = 'inline-block';
      setTimeout(() => demoToast.style.display = 'none', 1500);
    });

    btn.addEventListener('click', async () => {
      const original = btn.innerHTML;
      btn.innerHTML = '<span class="spin">âŸ³</span> Checkingâ€¦';
      btn.disabled = true;
      try {
        const res = await fetch('/status');
        const d = await res.json();

        const okBadge = (ok, text) =>
          `<span class="badge rounded-pill ${ok ? 'badge-ok' : 'badge-bad'}">${text}</span>`;

        list.innerHTML = `
          <li class="list-group-item bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
              <div>Redis (cache)</div>
              ${okBadge(d.redis && d.redis.ok, d.redis && d.redis.ok ? 'pong' : 'error')}
            </div>
            <div class="mt-2 small">
              <code>counter</code> = ${(d.redis && d.redis.counter) || 0},
              <code>dbsize</code> = ${(d.redis && d.redis.dbsize) || 0},
              <code>used_memory</code> = ${(d.redis && d.redis.used_memory) || 'n/a'}
            </div>
          </li>
          <li class="list-group-item bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
              <div>Postgres (database)</div>
              ${okBadge(d.postgres && d.postgres.ok, d.postgres && d.postgres.ok ? 'ok' : 'error')}
            </div>
            <div class="mt-2 small">
              <code>server_version</code> = ${JSON.stringify((d.postgres && d.postgres.server_version) || 'n/a')},
              <code>rows_in_proof</code> = ${(d.postgres && d.postgres.rows_in_proof) || 0},
              <code>last_insert_id</code> = ${JSON.stringify((d.postgres && d.postgres.last_insert_id) || 'n/a')}
            </div>
          </li>
        `;
      } catch (e) {
        alert('Refresh failed: ' + e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
    });

    resetBtn.addEventListener('click', async () => {
      resetBtn.disabled = true;
      try {
        await fetch('/reset', { method: 'POST' });
        alert('Reset done. Click Re-check Status again.');
      } catch (e) {
        alert('Reset failed: ' + e);
      } finally {
        resetBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
